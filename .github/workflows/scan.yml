# Code scan for software release

name: 'Scan'
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  precheck:
    runs-on: [self-hosted, scan]
    continue-on-error: true
    outputs:
      should_run: ${{ steps.set_condition.outputs.should_run }}
    steps:
      - name: Set condition for PR title or commit message
        id: set_condition
        run: |
          echo "Checking PR title or commit message..."
          TYPES_TO_SKIP=("ci" "docs")
          should_run=true
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            for type in "${TYPES_TO_SKIP[@]}"; do
              if [[ "${{ github.event.pull_request.title }}" == "$type:"* ]]; then
                echo "Skip because PR title starts with '$type:'"
                should_run=false
                break
              fi
            done
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            for type in "${TYPES_TO_SKIP[@]}"; do
              if [[ "${{ github.head_commit.message }}" == "$type:"* ]]; then
                echo "Skip because commit message starts with '$type:'"
                should_run=false
                break
              fi
            done
          fi
          echo "should_run=$should_run" >> $GITHUB_OUTPUT

  bandit:
    name: Bandit
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: [self-hosted, scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: amr-registry.caas.intel.com
          username: ${{ secrets.CI_USR }}
          password: ${{ secrets.CI_PWD }}

      # release package must be in the directory
      - name: Prepare release package
        run: |
          RLDIR="release_$(echo ${GITHUB_SHA:0:7})"
          echo "STEP_PACKAGE_NAME=${RLDIR}" >> $GITHUB_ENV
          mkdir -p ${RLDIR} && rsync -av --progress $(ls -I ${RLDIR}) ${RLDIR}/ --exclude .git --exclude .github

      - name: Execute bandit scan
        uses: intel-innersource/frameworks.devops.github.actions.bandit@main
        with:
          scan_path: '${{ env.STEP_PACKAGE_NAME }}'

  virus-scan:
    name: Virus Scan
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: [self-hosted, scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # release package must be in the directory
      - name: Prepare release package
        run: |
          RLDIR="release_$(echo ${GITHUB_SHA:0:7})"
          echo "STEP_PACKAGE_NAME=${RLDIR}" >> $GITHUB_ENV
          mkdir -p ${RLDIR} && rsync -av --progress $(ls -I ${RLDIR}) ${RLDIR}/ --exclude .git --exclude .github

      - name: Execute virus scan
        uses: intel-innersource/frameworks.devops.github.actions.mcafee@main
        with:
          scan_path: '${{ env.STEP_PACKAGE_NAME }}'
          fail_build: false

  shellcheck:
    name: ShellCheck
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: [self-hosted, scan]
    env:
      SHELLCHECK_OPTS: ""
      # Notes:
      # - [optional] replace SHELLCHECK_EXIT_CODE value to 1 if you are enabling ShellCheck as a static code analysis tool
      SHELLCHECK_EXIT_CODE: 1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find shell script files
        id: find_files
        run: |
          find . \
            -name .git -type d -prune -o \
            -type f -name \*.sh \
            -print0 > shell_files.txt
          tr '\0' '\n' < shell_files.txt > shell_files_readable.txt
          total_files=$(wc -l < shell_files_readable.txt)
          echo "Total number of shell script files to be scanned: $total_files"
          cat shell_files_readable.txt

      - name: Execute ShellCheck
        run: |
          xargs -0 -r -n1 shellcheck < shell_files.txt 2>&1 | tee shellcheck.log
          if [ -s "shellcheck.log" ]; then
            grep -oP 'In \K[^\s:]+' shellcheck.log | sort -u > shellcheck_summary.txt
            total_issues=$(grep -c '^In ' shellcheck.log)
            echo "::error::Found $total_issues issues!"
            exit ${{ env.SHELLCHECK_EXIT_CODE }}
          else
            echo "No issues found by ShellCheck" > shellcheck.log
          fi

      - name: Preview ShellCheck Summary
        if: always()
        run: |
          {
            echo "Total number of shell script files to be scanned: $(wc -l < shell_files_readable.txt)"
            echo "Files scanned:"
            cat shell_files_readable.txt
            echo ""
            if [ -f shellcheck_summary.txt ]; then
              echo "Files with issues:"
              cat shellcheck_summary.txt
              total_files_with_issues=$(wc -l < shellcheck_summary.txt)
              total_issues=$(grep -c '^In ' shellcheck.log)
              echo "Total number of files with issues: $total_files_with_issues"
              echo "Total number of issues: $total_issues"
              echo "Issue types and their counts:"
              grep -oP 'SC[0-9]+' shellcheck.log | sort | uniq -c | sort -nr
            else
              echo "No issues found by ShellCheck"
            fi
          } | tee shellcheck_summary.log

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Shellcheck Reports
          path: |
            shellcheck.log
            shellcheck_summary.log

  trivy:
    name: Trivy
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: [self-hosted, scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute Trivy - csv
        run: |
          trivy fs \
            --format template --template  @/home/user/.ci/csv.tpl \
            --exit-code  1 \
            --vuln-type os,library \
            --severity  UNKNOWN,LOW,MEDIUM,CRITICAL,HIGH \
            --output  trivy_fs_report.csv \
            --list-all-pkgs .

      - name: Preview Trivy report
        if: always()
        run: |
          if [ -f "trivy_fs_report.csv" ]; then
            cat trivy_fs_report.csv
          else
            echo "Trivy report file not found."
          fi

      - name: Upload artifact - csv
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Trivy Reports
          path: "trivy_fs_report.csv"

  trivy-sbom:
    name: Trivy SBOM
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: [self-hosted, scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute Trivy
        run: |
          ls -l ~/.ci/csv.tpl
          trivy fs \
            --format spdx-json \
            --output  trivy_fs_sbom_report.json .

      - name: Upload artifact 
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Trivy SBOM Reports
          path: "trivy_fs_sbom_report.json"

  bdba:
    name: BDBA
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: [self-hosted, scan]
    env:
      STEP_GROUP_ID: '32'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # release package must .zip file
      - name: Prepare release package
        run: |
          RLDIR="release_$(echo ${GITHUB_SHA:0:7})"
          echo "STEP_PACKAGE_NAME=${RLDIR}" >> $GITHUB_ENV
          zip -r ${RLDIR}.zip . -x "*.git*" "*.github*"

      - name: Execute BDBA
        uses: intel-innersource/frameworks.devops.github.actions.bdba@main
        with:
          username: ${{ secrets.CI_USR }}
          password: ${{ secrets.CI_PWD }}
          # token: ${{ secrets.CI_BDBA_TOKEN }}
          group: ${{ env.STEP_GROUP_ID }}
          scan_path: '${{ env.STEP_PACKAGE_NAME }}.zip'

  protex:
    name: Protex
    needs: precheck
    if: needs.precheck.outputs.should_run == 'true'
    runs-on: [self-hosted, scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # release package must be in the directory
      - name: Prepare release package
        run: |
          RLDIR="release_$(echo ${GITHUB_SHA:0:7})"
          echo "STEP_PACKAGE_NAME=${RLDIR}" >> $GITHUB_ENV
          mkdir -p ${RLDIR} && rsync -av --progress $(ls -I ${RLDIR}) ${RLDIR}/ --exclude .git --exclude .github

      - name: Execute Protex
        uses: intel-innersource/frameworks.actions.protex@main
        with:
          # project_name must matched with the project that already created
          project_name: Edge Developer Kit Reference Scripts
          server: https://garprotex010.devtools.intel.com
          user: ${{ secrets.CI_USR }}
          password: ${{ secrets.CI_PWD }}
          path: '${{ env.STEP_PACKAGE_NAME }}'
